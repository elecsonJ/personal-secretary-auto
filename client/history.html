<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>알림 히스토리 - 개인 비서</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .notification-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #007AFF;
        }
        .notification-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .notification-body {
            color: #666;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .notification-time {
            font-size: 0.85em;
            color: #999;
            margin-top: 8px;
        }
        .no-notifications {
            text-align: center;
            color: #999;
            padding: 40px;
            background: white;
            border-radius: 8px;
        }
        .refresh-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .clear-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .back-btn {
            background: #34C759;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📱 알림 히스토리</h1>
        <p>받은 모든 알림을 확인할 수 있습니다</p>
        <a href="/" class="back-btn">← 홈으로</a>
        <button class="refresh-btn" onclick="loadNotifications()">🔄 새로고침</button>
        <button class="clear-btn" onclick="clearHistory()">🗑️ 삭제</button>
    </div>

    <div id="notifications-container">
        <div class="no-notifications">알림 로딩 중...</div>
    </div>

    <script>
        // 알림 히스토리 저장/불러오기
        function saveNotification(title, body, time = new Date()) {
            const notifications = getNotifications();
            const newNotification = {
                id: Date.now(),
                title: title,
                body: body,
                time: time.toISOString(),
                timestamp: time.getTime()
            };
            
            notifications.unshift(newNotification); // 최신이 위로
            
            // 최대 50개까지만 저장
            if (notifications.length > 50) {
                notifications.splice(50);
            }
            
            localStorage.setItem('fcm_notifications', JSON.stringify(notifications));
        }

        function getNotifications() {
            const stored = localStorage.getItem('fcm_notifications');
            return stored ? JSON.parse(stored) : [];
        }

        async function getIndexedDBNotifications() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FCMNotifications', 1);
                
                request.onerror = () => {
                    console.log('[INDEXEDDB] 데이터베이스 열기 실패');
                    resolve([]);
                };
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('notifications')) {
                        console.log('[INDEXEDDB] notifications 스토어가 없음');
                        resolve([]);
                        return;
                    }
                    
                    const transaction = db.transaction(['notifications'], 'readonly');
                    const store = transaction.objectStore('notifications');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const notifications = request.result || [];
                        // 시간순으로 정렬 (최신순)
                        notifications.sort((a, b) => b.timestamp - a.timestamp);
                        console.log('[INDEXEDDB] IndexedDB에서 알림 로드:', notifications.length, '개');
                        resolve(notifications);
                    };
                    
                    request.onerror = () => {
                        console.error('[INDEXEDDB] 데이터 조회 실패');
                        resolve([]);
                    };
                };
            });
        }

        async function getServerNotifications() {
            try {
                console.log('[SERVER] 서버 히스토리 요청 시작...');
                const response = await fetch('/api/notifications');
                console.log('[SERVER] 응답 상태:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[SERVER] 전체 응답:', result);
                    
                    // API 응답 구조에 맞게 수정
                    const notifications = result.notifications || result || [];
                    console.log('[SERVER] 서버에서 알림 히스토리 로드:', notifications.length, '개');
                    return notifications;
                } else {
                    console.error('[SERVER] API 응답 오류:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('[SERVER] 서버 알림 히스토리 로드 실패:', error);
                console.log('[SERVER] 대안: 파일 기반 히스토리 시도...');
                return await getFileBasedNotifications();
            }
            return [];
        }

        async function getFileBasedNotifications() {
            try {
                // 파일 기반 히스토리 접근 시도 (정적 파일 서버가 있을 경우)
                const response = await fetch('../data/notification-history.json');
                if (response.ok) {
                    const notifications = await response.json();
                    console.log('[FILE] 파일에서 알림 히스토리 로드:', notifications.length, '개');
                    return notifications;
                }
            } catch (error) {
                console.log('[FILE] 파일 기반 히스토리 로드 실패:', error);
            }
            return [];
        }

        function mergeNotifications(localNotifications, serverNotifications, indexedDBNotifications) {
            const merged = [...localNotifications];
            
            // IndexedDB 알림을 추가 (FCM에서 직접 저장된 것들)
            indexedDBNotifications.forEach(idbNotif => {
                const exists = merged.some(localNotif => 
                    Math.abs(new Date(localNotif.time) - new Date(idbNotif.time)) < 5000 && 
                    localNotif.title === idbNotif.title
                );
                
                if (!exists) {
                    merged.push({
                        id: idbNotif.id,
                        title: idbNotif.title,
                        body: idbNotif.body,
                        time: idbNotif.time,
                        timestamp: idbNotif.timestamp,
                        source: 'fcm-direct'  // FCM에서 직접 저장됨을 표시
                    });
                }
            });
            
            // 서버 알림을 추가
            serverNotifications.forEach(serverNotif => {
                const exists = merged.some(localNotif => 
                    Math.abs(new Date(localNotif.time) - new Date(serverNotif.timestamp)) < 5000 && 
                    localNotif.title === serverNotif.title
                );
                
                if (!exists) {
                    merged.push({
                        id: serverNotif.id,
                        title: serverNotif.title,
                        body: serverNotif.body,
                        time: serverNotif.timestamp,
                        timestamp: new Date(serverNotif.timestamp).getTime(),
                        source: serverNotif.source || 'server'
                    });
                }
            });
            
            // 시간순으로 정렬 (최신순)
            merged.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            return merged;
        }

        function clearHistory() {
            if (confirm('모든 알림 히스토리를 삭제하시겠습니까?')) {
                localStorage.removeItem('notificationHistory');
                loadNotifications();
            }
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '방금 전';
            if (diff < 3600000) return Math.floor(diff/60000) + '분 전';
            if (diff < 86400000) return Math.floor(diff/3600000) + '시간 전';
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        async function loadNotifications() {
            const container = document.getElementById('notifications-container');
            container.innerHTML = '<div class="no-notifications">알림 로딩 중...</div>';
            
            try {
                // 로컬 스토리지에서 알림 히스토리 불러오기
                const notifications = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
                
                if (notifications.length === 0) {
                    container.innerHTML = '<div class="no-notifications">저장된 알림이 없습니다</div>';
                    return;
                }
                
                container.innerHTML = notifications.map(notif => {
                    return `
                        <div class="notification-item">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-body">${notif.body}</div>
                            <div class="notification-time">${formatTime(notif.time)}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('알림 로딩 실패:', error);
                container.innerHTML = '<div class="no-notifications">알림 로딩 중 오류가 발생했습니다</div>';
            }
        }

        // 페이지 로드 시 알림 불러오기
        loadNotifications();

        // 5초마다 자동 새로고침
        setInterval(loadNotifications, 5000);

        // Service Worker에서 알림을 받았을 때 자동으로 저장하도록 이벤트 리스너 추가
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('[HISTORY] Service Worker 메시지 수신:', event.data);
                if (event.data && event.data.type === 'FCM_NOTIFICATION') {
                    const time = event.data.time ? new Date(event.data.time) : new Date();
                    saveNotification(event.data.title, event.data.body, time);
                    loadNotifications();
                    console.log('[HISTORY] 알림 히스토리에 저장됨:', event.data.title);
                }
            });
            
            // Service Worker 등록 확인
            navigator.serviceWorker.ready.then(registration => {
                console.log('[HISTORY] Service Worker 등록 완료:', registration);
            });
        }

        // 테스트 알림 추가 (개발용)
        function addTestNotification() {
            saveNotification('🧪 테스트 알림', '이것은 테스트 알림입니다.\n히스토리 기능이 정상 작동하는지 확인해보세요!');
            loadNotifications();
        }

        // 서버 테스트 알림 추가
        async function addServerTestNotification() {
            try {
                const response = await fetch('/api/test-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: '🖥️ 서버 테스트 알림',
                        body: '서버 측 알림 히스토리 저장 기능이 정상 작동합니다!'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[SERVER] 서버 테스트 알림 전송 성공:', result);
                    alert('서버 테스트 알림이 전송되었습니다!');
                    setTimeout(loadNotifications, 1000); // 1초 후 새로고침
                } else {
                    console.error('[SERVER] 서버 테스트 알림 전송 실패:', response.status);
                    alert('서버 테스트 알림 전송에 실패했습니다. 서버가 실행 중인지 확인하세요.');
                }
            } catch (error) {
                console.error('[SERVER] 서버 테스트 알림 요청 실패:', error);
                alert('서버에 연결할 수 없습니다. 서버가 실행 중인지 확인하세요.');
            }
        }

    </script>
</body>
</html>