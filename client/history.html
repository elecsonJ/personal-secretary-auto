<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•Œë¦¼ íˆìŠ¤í† ë¦¬ - ê°œì¸ ë¹„ì„œ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .notification-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #007AFF;
        }
        .notification-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .notification-body {
            color: #666;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .notification-time {
            font-size: 0.85em;
            color: #999;
            margin-top: 8px;
        }
        .no-notifications {
            text-align: center;
            color: #999;
            padding: 40px;
            background: white;
            border-radius: 8px;
        }
        .refresh-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .clear-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .back-btn {
            background: #34C759;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“± ì•Œë¦¼ íˆìŠ¤í† ë¦¬</h1>
        <p>ë°›ì€ ëª¨ë“  ì•Œë¦¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        <a href="/" class="back-btn">â† í™ˆìœ¼ë¡œ</a>
        <button class="refresh-btn" onclick="loadNotifications()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ ì‚­ì œ</button>
    </div>

    <div id="notifications-container">
        <div class="no-notifications">ì•Œë¦¼ ë¡œë”© ì¤‘...</div>
    </div>

    <script>
        // ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function saveNotification(title, body, time = new Date()) {
            const notifications = getNotifications();
            const newNotification = {
                id: Date.now(),
                title: title,
                body: body,
                time: time.toISOString(),
                timestamp: time.getTime()
            };
            
            notifications.unshift(newNotification); // ìµœì‹ ì´ ìœ„ë¡œ
            
            // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ì €ì¥
            if (notifications.length > 50) {
                notifications.splice(50);
            }
            
            localStorage.setItem('fcm_notifications', JSON.stringify(notifications));
        }

        function getNotifications() {
            const stored = localStorage.getItem('fcm_notifications');
            return stored ? JSON.parse(stored) : [];
        }

        async function getIndexedDBNotifications() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FCMNotifications', 1);
                
                request.onerror = () => {
                    console.log('[INDEXEDDB] ë°ì´í„°ë² ì´ìŠ¤ ì—´ê¸° ì‹¤íŒ¨');
                    resolve([]);
                };
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('notifications')) {
                        console.log('[INDEXEDDB] notifications ìŠ¤í† ì–´ê°€ ì—†ìŒ');
                        resolve([]);
                        return;
                    }
                    
                    const transaction = db.transaction(['notifications'], 'readonly');
                    const store = transaction.objectStore('notifications');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const notifications = request.result || [];
                        // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
                        notifications.sort((a, b) => b.timestamp - a.timestamp);
                        console.log('[INDEXEDDB] IndexedDBì—ì„œ ì•Œë¦¼ ë¡œë“œ:', notifications.length, 'ê°œ');
                        resolve(notifications);
                    };
                    
                    request.onerror = () => {
                        console.error('[INDEXEDDB] ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
                        resolve([]);
                    };
                };
            });
        }

        async function getServerNotifications() {
            try {
                console.log('[SERVER] ì„œë²„ íˆìŠ¤í† ë¦¬ ìš”ì²­ ì‹œì‘...');
                const response = await fetch('/api/notifications');
                console.log('[SERVER] ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[SERVER] ì „ì²´ ì‘ë‹µ:', result);
                    
                    // API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •
                    const notifications = result.notifications || result || [];
                    console.log('[SERVER] ì„œë²„ì—ì„œ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ë¡œë“œ:', notifications.length, 'ê°œ');
                    return notifications;
                } else {
                    console.error('[SERVER] API ì‘ë‹µ ì˜¤ë¥˜:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('[SERVER] ì„œë²„ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                console.log('[SERVER] ëŒ€ì•ˆ: íŒŒì¼ ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ì‹œë„...');
                return await getFileBasedNotifications();
            }
            return [];
        }

        async function getFileBasedNotifications() {
            try {
                // íŒŒì¼ ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ì ‘ê·¼ ì‹œë„ (ì •ì  íŒŒì¼ ì„œë²„ê°€ ìˆì„ ê²½ìš°)
                const response = await fetch('../data/notification-history.json');
                if (response.ok) {
                    const notifications = await response.json();
                    console.log('[FILE] íŒŒì¼ì—ì„œ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ë¡œë“œ:', notifications.length, 'ê°œ');
                    return notifications;
                }
            } catch (error) {
                console.log('[FILE] íŒŒì¼ ê¸°ë°˜ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            return [];
        }

        function mergeNotifications(localNotifications, serverNotifications, indexedDBNotifications) {
            const merged = [...localNotifications];
            
            // IndexedDB ì•Œë¦¼ì„ ì¶”ê°€ (FCMì—ì„œ ì§ì ‘ ì €ì¥ëœ ê²ƒë“¤)
            indexedDBNotifications.forEach(idbNotif => {
                const exists = merged.some(localNotif => 
                    Math.abs(new Date(localNotif.time) - new Date(idbNotif.time)) < 5000 && 
                    localNotif.title === idbNotif.title
                );
                
                if (!exists) {
                    merged.push({
                        id: idbNotif.id,
                        title: idbNotif.title,
                        body: idbNotif.body,
                        time: idbNotif.time,
                        timestamp: idbNotif.timestamp,
                        source: 'fcm-direct'  // FCMì—ì„œ ì§ì ‘ ì €ì¥ë¨ì„ í‘œì‹œ
                    });
                }
            });
            
            // ì„œë²„ ì•Œë¦¼ì„ ì¶”ê°€
            serverNotifications.forEach(serverNotif => {
                const exists = merged.some(localNotif => 
                    Math.abs(new Date(localNotif.time) - new Date(serverNotif.timestamp)) < 5000 && 
                    localNotif.title === serverNotif.title
                );
                
                if (!exists) {
                    merged.push({
                        id: serverNotif.id,
                        title: serverNotif.title,
                        body: serverNotif.body,
                        time: serverNotif.timestamp,
                        timestamp: new Date(serverNotif.timestamp).getTime(),
                        source: serverNotif.source || 'server'
                    });
                }
            });
            
            // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
            merged.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            return merged;
        }

        function clearHistory() {
            if (confirm('ëª¨ë“  ì•Œë¦¼ íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('notificationHistory');
                loadNotifications();
            }
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600000) return Math.floor(diff/60000) + 'ë¶„ ì „';
            if (diff < 86400000) return Math.floor(diff/3600000) + 'ì‹œê°„ ì „';
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        async function loadNotifications() {
            const container = document.getElementById('notifications-container');
            container.innerHTML = '<div class="no-notifications">ì•Œë¦¼ ë¡œë”© ì¤‘...</div>';
            
            try {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
                const notifications = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
                
                if (notifications.length === 0) {
                    container.innerHTML = '<div class="no-notifications">ì €ì¥ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                container.innerHTML = notifications.map(notif => {
                    return `
                        <div class="notification-item">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-body">${notif.body}</div>
                            <div class="notification-time">${formatTime(notif.time)}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('ì•Œë¦¼ ë¡œë”© ì‹¤íŒ¨:', error);
                container.innerHTML = '<div class="no-notifications">ì•Œë¦¼ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
        loadNotifications();

        // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadNotifications, 5000);

        // Service Workerì—ì„œ ì•Œë¦¼ì„ ë°›ì•˜ì„ ë•Œ ìë™ìœ¼ë¡œ ì €ì¥í•˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('[HISTORY] Service Worker ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);
                if (event.data && event.data.type === 'FCM_NOTIFICATION') {
                    const time = event.data.time ? new Date(event.data.time) : new Date();
                    saveNotification(event.data.title, event.data.body, time);
                    loadNotifications();
                    console.log('[HISTORY] ì•Œë¦¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë¨:', event.data.title);
                }
            });
            
            // Service Worker ë“±ë¡ í™•ì¸
            navigator.serviceWorker.ready.then(registration => {
                console.log('[HISTORY] Service Worker ë“±ë¡ ì™„ë£Œ:', registration);
            });
        }

        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì¶”ê°€ (ê°œë°œìš©)
        function addTestNotification() {
            saveNotification('ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼', 'ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì…ë‹ˆë‹¤.\níˆìŠ¤í† ë¦¬ ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”!');
            loadNotifications();
        }

        // ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì¶”ê°€
        async function addServerTestNotification() {
            try {
                const response = await fetch('/api/test-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'ğŸ–¥ï¸ ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼',
                        body: 'ì„œë²„ ì¸¡ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ì €ì¥ ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[SERVER] ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ:', result);
                    alert('ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    setTimeout(loadNotifications, 1000); // 1ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨
                } else {
                    console.error('[SERVER] ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', response.status);
                    alert('ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
                }
            } catch (error) {
                console.error('[SERVER] ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìš”ì²­ ì‹¤íŒ¨:', error);
                alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
            }
        }

    </script>
</body>
</html>