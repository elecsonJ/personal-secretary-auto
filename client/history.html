<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•Œë¦¼ íˆìŠ¤í† ë¦¬ - ê°œì¸ ë¹„ì„œ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .notification-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #007AFF;
        }
        .notification-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .notification-body {
            color: #666;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .notification-time {
            font-size: 0.85em;
            color: #999;
            margin-top: 8px;
        }
        .no-notifications {
            text-align: center;
            color: #999;
            padding: 40px;
            background: white;
            border-radius: 8px;
        }
        .refresh-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .clear-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“± ê°œì¸ ë¹„ì„œ ì•Œë¦¼ íˆìŠ¤í† ë¦¬</h1>
        <p>ìµœê·¼ ë°›ì€ FCM ì•Œë¦¼ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        <button class="refresh-btn" onclick="loadNotifications()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ íˆìŠ¤í† ë¦¬ ì‚­ì œ</button>
    </div>

    <div id="notifications-container">
        <div class="no-notifications">ì•Œë¦¼ ë¡œë”© ì¤‘...</div>
    </div>

    <script>
        // ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function saveNotification(title, body, time = new Date()) {
            const notifications = getNotifications();
            const newNotification = {
                id: Date.now(),
                title: title,
                body: body,
                time: time.toISOString(),
                timestamp: time.getTime()
            };
            
            notifications.unshift(newNotification); // ìµœì‹ ì´ ìœ„ë¡œ
            
            // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ì €ì¥
            if (notifications.length > 50) {
                notifications.splice(50);
            }
            
            localStorage.setItem('fcm_notifications', JSON.stringify(notifications));
        }

        function getNotifications() {
            const stored = localStorage.getItem('fcm_notifications');
            return stored ? JSON.parse(stored) : [];
        }

        async function getServerNotifications() {
            try {
                const response = await fetch('/api/notifications');
                if (response.ok) {
                    const data = await response.json();
                    console.log('[SERVER] ì„œë²„ì—ì„œ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ë¡œë“œ:', data.length, 'ê°œ');
                    return data;
                }
            } catch (error) {
                console.log('[SERVER] ì„œë²„ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            return [];
        }

        function mergeNotifications(localNotifications, serverNotifications) {
            const merged = [...localNotifications];
            
            // ì„œë²„ ì•Œë¦¼ì„ ë¡œì»¬ì— ì—†ëŠ” ê²ƒë§Œ ì¶”ê°€
            serverNotifications.forEach(serverNotif => {
                const exists = merged.some(localNotif => 
                    Math.abs(new Date(localNotif.time) - new Date(serverNotif.timestamp)) < 5000 && 
                    localNotif.title === serverNotif.title
                );
                
                if (!exists) {
                    merged.push({
                        id: serverNotif.id,
                        title: serverNotif.title,
                        body: serverNotif.body,
                        time: serverNotif.timestamp,
                        timestamp: new Date(serverNotif.timestamp).getTime(),
                        source: serverNotif.source || 'server'
                    });
                }
            });
            
            // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
            merged.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            return merged;
        }

        function clearHistory() {
            if (confirm('ëª¨ë“  ì•Œë¦¼ íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('fcm_notifications');
                loadNotifications();
            }
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600000) return Math.floor(diff/60000) + 'ë¶„ ì „';
            if (diff < 86400000) return Math.floor(diff/3600000) + 'ì‹œê°„ ì „';
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        async function loadNotifications() {
            const container = document.getElementById('notifications-container');
            container.innerHTML = '<div class="no-notifications">ì•Œë¦¼ ë¡œë”© ì¤‘...</div>';
            
            try {
                const localNotifications = getNotifications();
                const serverNotifications = await getServerNotifications();
                const allNotifications = mergeNotifications(localNotifications, serverNotifications);
                
                console.log('[MERGE] ë¡œì»¬:', localNotifications.length, 'ê°œ, ì„œë²„:', serverNotifications.length, 'ê°œ, í†µí•©:', allNotifications.length, 'ê°œ');
                
                if (allNotifications.length === 0) {
                    container.innerHTML = '<div class="no-notifications">ì €ì¥ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                container.innerHTML = allNotifications.map(notif => {
                    const sourceLabel = notif.source === 'server' ? 'ğŸ–¥ï¸' : 'ğŸ“±';
                    return `
                        <div class="notification-item">
                            <div class="notification-title">${sourceLabel} ${notif.title}</div>
                            <div class="notification-body">${notif.body}</div>
                            <div class="notification-time">${formatTime(notif.time)}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('[LOAD] ì•Œë¦¼ ë¡œë”© ì‹¤íŒ¨:', error);
                container.innerHTML = '<div class="no-notifications">ì•Œë¦¼ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
        loadNotifications();

        // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadNotifications, 5000);

        // Service Workerì—ì„œ ì•Œë¦¼ì„ ë°›ì•˜ì„ ë•Œ ìë™ìœ¼ë¡œ ì €ì¥í•˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('[HISTORY] Service Worker ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);
                if (event.data && event.data.type === 'FCM_NOTIFICATION') {
                    const time = event.data.time ? new Date(event.data.time) : new Date();
                    saveNotification(event.data.title, event.data.body, time);
                    loadNotifications();
                    console.log('[HISTORY] ì•Œë¦¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë¨:', event.data.title);
                }
            });
            
            // Service Worker ë“±ë¡ í™•ì¸
            navigator.serviceWorker.ready.then(registration => {
                console.log('[HISTORY] Service Worker ë“±ë¡ ì™„ë£Œ:', registration);
            });
        }

        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì¶”ê°€ (ê°œë°œìš©)
        function addTestNotification() {
            saveNotification('ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼', 'ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì…ë‹ˆë‹¤.\níˆìŠ¤í† ë¦¬ ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”!');
            loadNotifications();
        }

        // ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì¶”ê°€
        async function addServerTestNotification() {
            try {
                const response = await fetch('/api/test-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'ğŸ–¥ï¸ ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼',
                        body: 'ì„œë²„ ì¸¡ ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ì €ì¥ ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!'
                    })
                });
                
                if (response.ok) {
                    console.log('[SERVER] ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ');
                    setTimeout(loadNotifications, 1000); // 1ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨
                } else {
                    console.error('[SERVER] ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('[SERVER] ì„œë²„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìš”ì²­ ì‹¤íŒ¨:', error);
            }
        }

        // ê°œë°œ ëª¨ë“œì—ì„œ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            document.querySelector('.header').innerHTML += '<button class="refresh-btn" onclick="addTestNotification()">ğŸ§ª ë¡œì»¬ í…ŒìŠ¤íŠ¸</button>';
            document.querySelector('.header').innerHTML += '<button class="refresh-btn" onclick="addServerTestNotification()">ğŸ–¥ï¸ ì„œë²„ í…ŒìŠ¤íŠ¸</button>';
        }
    </script>
</body>
</html>