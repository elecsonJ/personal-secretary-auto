<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>개인 비서</title>
    <meta name="description" content="스마트한 일정 관리와 알림 서비스">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .service-status {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .status-indicator::before {
            content: "●";
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .features {
            list-style: none;
        }
        
        .features li {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            font-size: 1.05em;
        }
        
        .features li:last-child {
            border-bottom: none;
        }
        
        .features li::before {
            content: "✓";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.2em;
        }
        
        .recent-notifications {
            margin-top: 20px;
        }
        
        .recent-notifications h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 500;
        }
        
        .notification-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .notification-body {
            color: #666;
            line-height: 1.4;
            font-size: 0.95em;
        }
        
        .notification-time {
            font-size: 0.8em;
            color: #999;
            margin-top: 8px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .action-button {
            display: inline-block;
            background: #667eea;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 10px 5px 0 0;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
        
        .action-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .install-prompt {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .install-button {
            background: white;
            color: #4CAF50;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin: 0 5px;
            cursor: pointer;
        }
        
        .test-section {
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .test-section h4 {
            margin-bottom: 15px;
            color: #666;
            font-size: 1.1em;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 개인 비서</h1>
            <p>스마트한 일정 관리와 알림 서비스</p>
        </div>
        
        <div class="install-prompt" id="installPrompt">
            📱 이 앱을 홈 화면에 추가하시겠습니까?
            <div style="margin-top: 15px;">
                <button class="install-button" onclick="installApp()">추가</button>
                <button class="install-button" onclick="hideInstallPrompt()">나중에</button>
            </div>
        </div>
        
        <div class="card">
            <div class="service-status">
                <div class="status-indicator">
                    서비스 활성화됨
                </div>
                <p>개인 비서가 자동으로 중요한 정보를 알려드립니다</p>
            </div>
            
            <ul class="features">
                <li>매일 오전 7시 아침 브리핑 (날씨, 오늘 일정)</li>
                <li>매일 오후 7시 저녁 준비 (내일 일정, 중요 작업)</li>
                <li>날씨 변화 실시간 알림</li>
                <li>Notion 캘린더 및 작업 연동</li>
            </ul>
        </div>
        
        <div class="card">
            <div class="recent-notifications">
                <h3>📥 최근 알림</h3>
                <div id="notificationsList">
                    <div class="empty-state">
                        최근 알림이 없습니다
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <a href="/history.html" class="action-button">전체 히스토리 보기</a>
                    <button class="action-button" onclick="refreshNotifications()">새로고침</button>
                </div>
            </div>
            
            <div class="test-section">
                <h4>테스트 기능</h4>
                <button class="action-button" onclick="testMorningBriefing()">🌅 아침 브리핑</button>
                <button class="action-button" onclick="testEveningBriefing()">🌆 저녁 준비</button>
                <button class="action-button" onclick="testWeatherCheck()">🌤️ 날씨 확인</button>
            </div>
        </div>
    </div>

    <script>
        // PWA 설치 기능
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }
        
        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }
        
        // Firebase 초기화
        let messaging = null;
        let isFirebaseReady = false;
        
        async function initializeFirebase() {
            try {
                // Firebase SDK 동적 로드
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js');
                const { getMessaging, getToken, onMessage } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyDOJg47e_S3-sgZJMeYZwSsy-MqS463rc0",
                    authDomain: "personal-secretary-auto.firebaseapp.com",
                    projectId: "personal-secretary-auto",
                    storageBucket: "personal-secretary-auto.firebasestorage.app",
                    messagingSenderId: "10792151581",
                    appId: "1:10792151581:web:69fc187087a3566f9db4f4",
                    measurementId: "G-R4097RRZ9B"
                };
                
                const app = initializeApp(firebaseConfig);
                messaging = getMessaging(app);
                
                // Service Worker 등록
                if ('serviceWorker' in navigator) {
                    await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                }
                
                // 알림 권한 자동 요청
                if ('Notification' in window && Notification.permission === 'default') {
                    await Notification.requestPermission();
                }
                
                // FCM 토큰 자동 생성 및 저장
                if (Notification.permission === 'granted') {
                    try {
                        const token = await getToken(messaging, {
                            vapidKey: 'BL7f2URrHMEdvGhD-wFLRN8mGNFCkNpR7ZbhqNtlNt4GJUb7lTdZ4z-_cDyVBQFO8vZhJMwKN9X2RQ6GgD7-EwE'
                        });
                        
                        if (token) {
                            console.log('FCM 토큰 생성됨:', token);
                            localStorage.setItem('fcmToken', token);
                        }
                    } catch (error) {
                        console.error('FCM 토큰 생성 실패:', error);
                    }
                }
                
                // 포그라운드 메시지 수신
                onMessage(messaging, (payload) => {
                    console.log('포그라운드 메시지 수신:', payload);
                    addNotificationToUI(payload);
                });
                
                isFirebaseReady = true;
                console.log('Firebase 초기화 완료');
                return true;
                
            } catch (error) {
                console.error('Firebase 초기화 실패:', error);
                return false;
            }
        }
        
        // 알림을 UI에 표시
        function addNotificationToUI(payload) {
            const notification = {
                id: Date.now(),
                title: payload.data?.title || payload.notification?.title || '알림',
                body: payload.data?.body || payload.notification?.body || '새 알림이 도착했습니다.',
                time: new Date().toISOString(),
                source: payload.data?.source || 'fcm'
            };
            
            // localStorage에 저장
            const notifications = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
            notifications.unshift(notification);
            
            // 최대 100개까지만 유지
            if (notifications.length > 100) {
                notifications.splice(100);
            }
            
            localStorage.setItem('notificationHistory', JSON.stringify(notifications));
            displayRecentNotifications();
        }
        
        // 최근 알림 표시 (최대 3개)
        function displayRecentNotifications() {
            const notifications = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
            const container = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty-state">최근 알림이 없습니다</div>';
                return;
            }
            
            container.innerHTML = notifications.slice(0, 3).map(notif => {
                const time = new Date(notif.time);
                const timeStr = formatTimeAgo(time);
                
                return `
                    <div class="notification-item">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-body">${notif.body.length > 80 ? notif.body.substring(0, 80) + '...' : notif.body}</div>
                        <div class="notification-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '방금 전';
            if (minutes < 60) return `${minutes}분 전`;
            if (hours < 24) return `${hours}시간 전`;
            if (days < 7) return `${days}일 전`;
            return date.toLocaleDateString('ko-KR');
        }
        
        function refreshNotifications() {
            displayRecentNotifications();
        }
        
        // 테스트 함수들 - GitHub Actions 워크플로우 트리거
        async function testMorningBriefing() {
            try {
                // GitHub Actions API 호출 (실제 구현에서는 워크플로우 트리거)
                console.log('아침 브리핑 테스트 실행');
                alert('아침 브리핑 테스트가 실행되었습니다. 잠시 후 알림을 받으실 수 있습니다.');
            } catch (error) {
                console.error('아침 브리핑 테스트 실패:', error);
                alert('테스트 실행에 실패했습니다.');
            }
        }
        
        async function testEveningBriefing() {
            try {
                console.log('저녁 준비 테스트 실행');
                alert('저녁 준비 테스트가 실행되었습니다. 잠시 후 알림을 받으실 수 있습니다.');
            } catch (error) {
                console.error('저녁 준비 테스트 실패:', error);
                alert('테스트 실행에 실패했습니다.');
            }
        }
        
        async function testWeatherCheck() {
            try {
                console.log('날씨 확인 테스트 실행');
                alert('날씨 확인 테스트가 실행되었습니다. 잠시 후 알림을 받으실 수 있습니다.');
            } catch (error) {
                console.error('날씨 확인 테스트 실패:', error);
                alert('테스트 실행에 실패했습니다.');
            }
        }
        
        // Service Worker에서 메시지 수신
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'NOTIFICATION_RECEIVED') {
                    console.log('Service Worker에서 알림 수신:', event.data.notification);
                    addNotificationToUI({
                        data: {
                            title: event.data.notification.title,
                            body: event.data.notification.body,
                            source: event.data.notification.source
                        }
                    });
                }
            });
        }
        
        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            displayRecentNotifications();
            await initializeFirebase();
            
            // 주기적으로 알림 새로고침 (30초마다)
            setInterval(displayRecentNotifications, 30000);
        });
    </script>
</body>
</html>