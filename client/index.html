<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°œì¸ ë¹„ì„œ</title>
    <meta name="description" content="ìŠ¤ë§ˆíŠ¸í•œ ì¼ì • ê´€ë¦¬ì™€ ì•Œë¦¼ ì„œë¹„ìŠ¤">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .service-status {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .status-indicator::before {
            content: "â—";
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .features {
            list-style: none;
        }
        
        .features li {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            font-size: 1.05em;
        }
        
        .features li:last-child {
            border-bottom: none;
        }
        
        .features li::before {
            content: "âœ“";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.2em;
        }
        
        .recent-notifications {
            margin-top: 20px;
        }
        
        .recent-notifications h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 500;
        }
        
        .notification-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .notification-body {
            color: #666;
            line-height: 1.4;
            font-size: 0.95em;
        }
        
        .notification-time {
            font-size: 0.8em;
            color: #999;
            margin-top: 8px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .action-button {
            display: inline-block;
            background: #667eea;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 10px 5px 0 0;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
        
        .action-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .install-prompt {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .install-button {
            background: white;
            color: #4CAF50;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin: 0 5px;
            cursor: pointer;
        }
        
        .test-section {
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .test-section h4 {
            margin-bottom: 15px;
            color: #666;
            font-size: 1.1em;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– ê°œì¸ ë¹„ì„œ</h1>
            <p>ìŠ¤ë§ˆíŠ¸í•œ ì¼ì • ê´€ë¦¬ì™€ ì•Œë¦¼ ì„œë¹„ìŠ¤</p>
        </div>
        
        <div class="install-prompt" id="installPrompt">
            ğŸ“± ì´ ì•±ì„ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            <div style="margin-top: 15px;">
                <button class="install-button" onclick="installApp()">ì¶”ê°€</button>
                <button class="install-button" onclick="hideInstallPrompt()">ë‚˜ì¤‘ì—</button>
            </div>
        </div>
        
        <div class="card">
            <div class="service-status">
                <div class="status-indicator">
                    ì„œë¹„ìŠ¤ í™œì„±í™”ë¨
                </div>
                <p>ê°œì¸ ë¹„ì„œê°€ ìë™ìœ¼ë¡œ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤</p>
            </div>
            
            <ul class="features">
                <li>ë§¤ì¼ ì˜¤ì „ 7ì‹œ ì•„ì¹¨ ë¸Œë¦¬í•‘ (ë‚ ì”¨, ì˜¤ëŠ˜ ì¼ì •)</li>
                <li>ë§¤ì¼ ì˜¤í›„ 7ì‹œ ì €ë… ì¤€ë¹„ (ë‚´ì¼ ì¼ì •, ì¤‘ìš” ì‘ì—…)</li>
                <li>ë‚ ì”¨ ë³€í™” ì‹¤ì‹œê°„ ì•Œë¦¼</li>
                <li>Notion ìº˜ë¦°ë” ë° ì‘ì—… ì—°ë™</li>
            </ul>
        </div>
        
        <div class="card">
            <div class="recent-notifications">
                <h3>ğŸ“¥ ìµœê·¼ ì•Œë¦¼</h3>
                <div id="notificationsList">
                    <div class="empty-state">
                        ìµœê·¼ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <a href="/history.html" class="action-button">ì „ì²´ íˆìŠ¤í† ë¦¬ ë³´ê¸°</a>
                    <button class="action-button" onclick="refreshNotifications()">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
            
            <div class="test-section">
                <h4>í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥</h4>
                <button class="action-button" onclick="testMorningBriefing()">ğŸŒ… ì•„ì¹¨ ë¸Œë¦¬í•‘</button>
                <button class="action-button" onclick="testEveningBriefing()">ğŸŒ† ì €ë… ì¤€ë¹„</button>
                <button class="action-button" onclick="testWeatherCheck()">ğŸŒ¤ï¸ ë‚ ì”¨ í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // PWA ì„¤ì¹˜ ê¸°ëŠ¥
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }
        
        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }
        
        // Firebase ì´ˆê¸°í™”
        let messaging = null;
        let isFirebaseReady = false;
        
        async function initializeFirebase() {
            try {
                // Firebase SDK ë™ì  ë¡œë“œ
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js');
                const { getMessaging, getToken, onMessage } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyDOJg47e_S3-sgZJMeYZwSsy-MqS463rc0",
                    authDomain: "personal-secretary-auto.firebaseapp.com",
                    projectId: "personal-secretary-auto",
                    storageBucket: "personal-secretary-auto.firebasestorage.app",
                    messagingSenderId: "10792151581",
                    appId: "1:10792151581:web:69fc187087a3566f9db4f4",
                    measurementId: "G-R4097RRZ9B"
                };
                
                const app = initializeApp(firebaseConfig);
                messaging = getMessaging(app);
                
                // Service Worker ë“±ë¡
                if ('serviceWorker' in navigator) {
                    await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                }
                
                // ì•Œë¦¼ ê¶Œí•œ ìë™ ìš”ì²­
                if ('Notification' in window && Notification.permission === 'default') {
                    await Notification.requestPermission();
                }
                
                // FCM í† í° ìë™ ìƒì„± ë° ì €ì¥
                if (Notification.permission === 'granted') {
                    try {
                        const token = await getToken(messaging, {
                            vapidKey: 'BL7f2URrHMEdvGhD-wFLRN8mGNFCkNpR7ZbhqNtlNt4GJUb7lTdZ4z-_cDyVBQFO8vZhJMwKN9X2RQ6GgD7-EwE'
                        });
                        
                        if (token) {
                            console.log('FCM í† í° ìƒì„±ë¨:', token);
                            localStorage.setItem('fcmToken', token);
                        }
                    } catch (error) {
                        console.error('FCM í† í° ìƒì„± ì‹¤íŒ¨:', error);
                    }
                }
                
                // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ 
                onMessage(messaging, (payload) => {
                    console.log('í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ :', payload);
                    addNotificationToUI(payload);
                });
                
                isFirebaseReady = true;
                console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                return true;
                
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                return false;
            }
        }
        
        // ì•Œë¦¼ì„ UIì— í‘œì‹œ
        function addNotificationToUI(payload) {
            const notification = {
                id: Date.now(),
                title: payload.data?.title || payload.notification?.title || 'ì•Œë¦¼',
                body: payload.data?.body || payload.notification?.body || 'ìƒˆ ì•Œë¦¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.',
                time: new Date().toISOString(),
                source: payload.data?.source || 'fcm'
            };
            
            // localStorageì— ì €ì¥
            const notifications = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
            notifications.unshift(notification);
            
            // ìµœëŒ€ 100ê°œê¹Œì§€ë§Œ ìœ ì§€
            if (notifications.length > 100) {
                notifications.splice(100);
            }
            
            localStorage.setItem('notificationHistory', JSON.stringify(notifications));
            displayRecentNotifications();
        }
        
        // ìµœê·¼ ì•Œë¦¼ í‘œì‹œ (ìµœëŒ€ 3ê°œ)
        function displayRecentNotifications() {
            const notifications = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
            const container = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty-state">ìµœê·¼ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            container.innerHTML = notifications.slice(0, 3).map(notif => {
                const time = new Date(notif.time);
                const timeStr = formatTimeAgo(time);
                
                return `
                    <div class="notification-item">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-body">${notif.body.length > 80 ? notif.body.substring(0, 80) + '...' : notif.body}</div>
                        <div class="notification-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'ë°©ê¸ˆ ì „';
            if (minutes < 60) return `${minutes}ë¶„ ì „`;
            if (hours < 24) return `${hours}ì‹œê°„ ì „`;
            if (days < 7) return `${days}ì¼ ì „`;
            return date.toLocaleDateString('ko-KR');
        }
        
        function refreshNotifications() {
            displayRecentNotifications();
        }
        
        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ - GitHub Actions ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        async function testMorningBriefing() {
            try {
                // GitHub Actions API í˜¸ì¶œ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°)
                console.log('ì•„ì¹¨ ë¸Œë¦¬í•‘ í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
                alert('ì•„ì¹¨ ë¸Œë¦¬í•‘ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì•Œë¦¼ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì•„ì¹¨ ë¸Œë¦¬í•‘ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                alert('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        async function testEveningBriefing() {
            try {
                console.log('ì €ë… ì¤€ë¹„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
                alert('ì €ë… ì¤€ë¹„ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì•Œë¦¼ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì €ë… ì¤€ë¹„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                alert('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        async function testWeatherCheck() {
            try {
                console.log('ë‚ ì”¨ í™•ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
                alert('ë‚ ì”¨ í™•ì¸ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì•Œë¦¼ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ë‚ ì”¨ í™•ì¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                alert('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // Service Workerì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ 
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'NOTIFICATION_RECEIVED') {
                    console.log('Service Workerì—ì„œ ì•Œë¦¼ ìˆ˜ì‹ :', event.data.notification);
                    addNotificationToUI({
                        data: {
                            title: event.data.notification.title,
                            body: event.data.notification.body,
                            source: event.data.notification.source
                        }
                    });
                }
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            displayRecentNotifications();
            await initializeFirebase();
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì•Œë¦¼ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
            setInterval(displayRecentNotifications, 30000);
        });
    </script>
</body>
</html>