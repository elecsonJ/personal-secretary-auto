<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>개인 비서 자동화</title>
    <meta name="description" content="날씨와 Notion 기반 스마트 개인 비서">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .status.active {
            background: #4CAF50;
            color: white;
        }
        
        .status.inactive {
            background: #f44336;
            color: white;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .feature-list li::before {
            content: "✅";
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5a67d8;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .notification-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .notification-item h4 {
            margin-bottom: 8px;
            color: #333;
        }
        
        .notification-item p {
            color: #666;
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .notification-item small {
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .install-prompt {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .install-prompt button {
            background: white;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }
        }
        
        .detail-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .detail-btn:hover {
            background: #138496;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🤖 개인 비서 자동화</h1>
            <p>스마트한 일정 관리와 알림 서비스</p>
        </header>
        
        <div class="install-prompt" id="installPrompt">
            📱 이 앱을 홈화면에 설치하시겠습니까?
            <button onclick="installApp()">설치</button>
            <button onclick="hideInstallPrompt()">나중에</button>
        </div>
        
        <div class="card">
            <h2>🔔 알림 서비스</h2>
            <div class="status active">활성화됨</div>
            <ul class="feature-list">
                <li>매일 오전 7시 아침 브리핑 (날씨, 오늘 일정, 뉴스)</li>
                <li>매일 오후 7시 저녁 브리핑 (내일 일정, HIGH 우선순위 작업)</li>
                <li>날씨 변화 실시간 알림 (2시간마다 체크)</li>
                <li>Notion 캘린더 및 태스크 연동</li>
            </ul>
        </div>
        
        <div class="card">
            <h2>📋 최신 알림 내역</h2>
            <div id="notificationHistory">
                <div class="empty-state">아직 알림이 없습니다.</div>
            </div>
            <button class="btn" onclick="clearHistory()">내역 지우기</button>
        </div>
        
        <div class="card">
            <h2>⚙️ 테스트 기능</h2>
            <p>알림이 제대로 작동하는지 테스트해보세요.</p>
            <button class="btn" onclick="requestNotificationPermission()">알림 권한 요청</button>
            <button class="btn" onclick="testNotification()">테스트 알림</button>
            <button class="btn" onclick="registerServiceWorker()">서비스 워커 등록</button>
        </div>
        
        <div class="card">
            <h2>📊 시스템 상태</h2>
            <p><strong>알림 권한:</strong> <span id="notificationPermission">확인 중...</span></p>
            <p><strong>서비스 워커:</strong> <span id="serviceWorkerStatus">확인 중...</span></p>
            <p><strong>PWA 설치:</strong> <span id="pwaStatus">확인 중...</span></p>
        </div>
    </div>
    
    <!-- 알림 상세보기 모달 -->
    <div id="notificationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
        <div style="background: white; margin: 50px auto; padding: 30px; border-radius: 15px; max-width: 600px; position: relative;">
            <button onclick="closeModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            <h3 id="modalTitle" style="margin-bottom: 20px; color: #333;"></h3>
            <div id="modalContent" style="line-height: 1.6; color: #555; white-space: pre-wrap;"></div>
        </div>
    </div>
    
    <script>
        let deferredPrompt;
        const notificationHistory = JSON.parse(localStorage.getItem('notificationHistory')) || [];
        
        // PWA 설치 프롬프트 처리
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('사용자가 PWA 설치를 승인했습니다');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }
        
        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }
        
        // 서비스 워커 등록
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('서비스 워커 등록 성공:', registration);
                    updateSystemStatus();
                    alert('서비스 워커가 성공적으로 등록되었습니다!');
                } catch (error) {
                    console.error('서비스 워커 등록 실패:', error);
                    alert('서비스 워커 등록에 실패했습니다.');
                }
            }
        }
        
        // 알림 권한 요청
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                console.log('알림 권한:', permission);
                updateSystemStatus();
                if (permission === 'granted') {
                    alert('알림 권한이 승인되었습니다!');
                } else {
                    alert('알림 권한이 거부되었습니다.');
                }
            }
        }
        
        // 테스트 알림
        function testNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('🧪 테스트 알림', {
                    body: '개인 비서 자동화 시스템이 정상적으로 작동하고 있습니다.',
                    icon: '/icons/icon-192.png',
                    badge: '/icons/icon-72.png',
                    tag: 'test-notification',
                    timestamp: Date.now()
                });
                
                // 알림 내역에 추가
                addToHistory({
                    title: '🧪 테스트 알림',
                    body: '개인 비서 자동화 시스템이 정상적으로 작동하고 있습니다.',
                    timestamp: new Date().toISOString()
                });
                
                setTimeout(() => notification.close(), 5000);
            } else {
                alert('알림 권한이 필요합니다!');
            }
        }
        
        // 시스템 상태 업데이트
        function updateSystemStatus() {
            // 알림 권한 상태
            const permissionStatus = Notification.permission;
            document.getElementById('notificationPermission').textContent = 
                permissionStatus === 'granted' ? '✅ 허용됨' : 
                permissionStatus === 'denied' ? '❌ 거부됨' : '⚠️ 미설정';
            
            // 서비스 워커 상태
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(() => {
                    document.getElementById('serviceWorkerStatus').textContent = '✅ 활성화됨';
                }).catch(() => {
                    document.getElementById('serviceWorkerStatus').textContent = '❌ 비활성화됨';
                });
            } else {
                document.getElementById('serviceWorkerStatus').textContent = '❌ 지원 안 됨';
            }
            
            // PWA 설치 상태
            if (window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('pwaStatus').textContent = '✅ 설치됨';
            } else {
                document.getElementById('pwaStatus').textContent = '📱 브라우저에서 실행 중';
            }
        }
        
        // 알림 내역 추가
        function addToHistory(notification) {
            notificationHistory.unshift(notification);
            if (notificationHistory.length > 50) {
                notificationHistory.pop();
            }
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            displayNotificationHistory();
        }
        
        // 알림 내역 표시
        function displayNotificationHistory() {
            const historyDiv = document.getElementById('notificationHistory');
            
            if (notificationHistory.length === 0) {
                historyDiv.innerHTML = '<div class="empty-state">아직 알림이 없습니다.</div>';
                return;
            }
            
            historyDiv.innerHTML = notificationHistory.map((notification, index) => {
                const date = new Date(notification.timestamp);
                const formattedDate = date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR');
                
                return `
                    <div class="notification-item">
                        <h4>${notification.title}</h4>
                        <p>${notification.body.length > 100 ? notification.body.substring(0, 100) + '...' : notification.body}</p>
                        <small>${formattedDate}</small>
                        ${notification.body.length > 100 ? `<button class="detail-btn" onclick="showNotificationDetail(${index})">전체 보기</button>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // 알림 상세보기
        function showNotificationDetail(index) {
            const notification = notificationHistory[index];
            const modal = document.getElementById('notificationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = notification.title;
            modalContent.textContent = notification.body;
            modal.style.display = 'block';
        }
        
        // 모달 닫기
        function closeModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }
        
        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('notificationModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // 내역 지우기
        function clearHistory() {
            if (confirm('알림 내역을 모두 지우시겠습니까?')) {
                notificationHistory.length = 0;
                localStorage.removeItem('notificationHistory');
                displayNotificationHistory();
            }
        }
        
        // 서비스 워커에서 알림 수신 처리
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'NOTIFICATION_RECEIVED') {
                    addToHistory({
                        title: event.data.title,
                        body: event.data.body,
                        timestamp: event.data.timestamp || new Date().toISOString()
                    });
                }
            });
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            updateSystemStatus();
            displayNotificationHistory();
            registerServiceWorker();
        });
    </script>
</body>
</html>